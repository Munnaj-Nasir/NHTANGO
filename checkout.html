<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout</title>
  <!-- Bootstrap 5 (optional if you already load it) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f7f7f7;
    }

    .untree_co-section {
      padding: 40px 0;
    }

    .site-block-order-table th,
    .site-block-order-table td {
      vertical-align: middle;
    }

    .btn-black {
      background: #000;
      color: #fff;
      border-color: #000;
    }

    .btn-black:hover {
      background: #222;
      color: #fff;
      border-color: #222;
    }
  </style>
</head>

<body>

  <div class="untree_co-section">
    <div class="container">
      <div class="row mb-5">
        <div class="col-md-12">
          <!-- <div class="border p-4 rounded bg-white" role="alert">
          Returning customer? <a href="#">Click here</a> to login
        </div> -->
        </div>
      </div>

      <div class="row">
        <!-- Billing -->
        <div class="col-md-6 mb-5 mb-md-0">
          <h2 class="h3 mb-3 text-black">Billing Details</h2>
          <div class="p-3 p-lg-4 border bg-white">

            <div class="mb-3">
              <label for="c_country" class="form-label text-black">Country <span class="text-danger">*</span></label>
              <select id="c_country" class="form-select">
                <option value="">Select a country</option>
                <option>Pakistan</option>
                <option>United Kingdom</option>
                <option>United States</option>
                <option>United Arab Emirates</option>
                <option>Bangladesh</option>
                <option>Ghana</option>
                <option>Albania</option>
                <option>Bahrain</option>
                <option>Colombia</option>
                <option>Dominican Republic</option>
              </select>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label for="c_fname" class="form-label text-black">First Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="c_fname" name="c_fname">
              </div>
              <div class="col-md-6">
                <label for="c_lname" class="form-label text-black">Last Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="c_lname" name="c_lname">
              </div>
            </div>

            <!-- <div class="mt-3">
            <label for="c_companyname" class="form-label text-black">Company Name</label>
            <input type="text" class="form-control" id="c_companyname" name="c_companyname">
          </div> -->

            <div class="mt-3">
              <label for="c_address" class="form-label text-black">Address <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="c_address" name="c_address" placeholder="Street address">
            </div>

            <div class="mt-3">
              <input type="text" class="form-control" id="c_address2"
                placeholder="Apartment, suite, unit etc. (optional)">
            </div>

            <div class="row g-3 mt-1">
              <div class="col-md-6">
                <label for="c_state_country" class="form-label text-black">City / State <span
                    class="text-danger">*</span></label>
                <input type="text" class="form-control" id="c_state_country" name="c_state_country">
              </div>
              <div class="col-md-6">
                <label for="c_postal_zip" class="form-label text-black">Postal / Zip <span
                    class="text-danger">*</span></label>
                <input type="text" class="form-control" id="c_postal_zip" name="c_postal_zip">
              </div>
            </div>

            <div class="row g-3 mt-1 mb-3">
              <div class="col-md-6">
                <label for="c_email_address" class="form-label text-black">Email Address <span
                    class="text-danger">*</span></label>
                <input type="email" class="form-control" id="c_email_address" name="c_email_address">
              </div>
              <div class="col-md-6">
                <label for="c_phone" class="form-label text-black">Phone <span class="text-danger">*</span></label>
                <input type="tel" class="form-control" id="c_phone" name="c_phone" placeholder="Phone Number">
              </div>
            </div>

        <div class="mb-3">
              <label class="form-check-label text-black" for="c_create_account">
                <input type="checkbox" class="form-check-input me-2" value="1" id="c_create_account"> Create an account?
              </label>
              <div class="collapse" id="create_an_account">
                <div class="py-2">
                  <p class="mb-2 small">Create an account by entering the information below. If you are a returning
                    customer please login at the top of the page.</p>
                  <label for="c_account_password" class="form-label text-black">Account Password</label>
                  <input type="password" class="form-control" id="c_account_password" name="c_account_password"
                    placeholder="">
                </div>
              </div>
            </div> 

     <div class="mb-3">
              <label class="form-check-label text-black" for="c_ship_different_address">
                <input type="checkbox" class="form-check-input me-2" value="1" id="c_ship_different_address"> Ship To A
                Different Address?
              </label>
              <div class="collapse" id="ship_different_address">
                <div class="py-2">
                  <div class="mb-3">
                    <label for="c_diff_country" class="form-label text-black">Country <span
                        class="text-danger">*</span></label>
                    <select id="c_diff_country" class="form-select">
                      <option value="">Select a country</option>
                      <option>Pakistan</option>
                      <option>United Kingdom</option>
                      <option>United States</option>
                    </select>
                  </div>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="c_diff_fname" class="form-label text-black">First Name <span
                          class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="c_diff_fname" name="c_diff_fname">
                    </div>
                    <div class="col-md-6">
                      <label for="c_diff_lname" class="form-label text-black">Last Name <span
                          class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="c_diff_lname" name="c_diff_lname">
                    </div>
                  </div>
                  <div class="mt-3">
                    <label for="c_diff_companyname" class="form-label text-black">Company Name</label>
                    <input type="text" class="form-control" id="c_diff_companyname" name="c_diff_companyname">
                  </div>
                  <div class="mt-3">
                    <label for="c_diff_address" class="form-label text-black">Address <span
                        class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="c_diff_address" name="c_diff_address"
                      placeholder="Street address">
                  </div>
                  <div class="mt-3">
                    <input type="text" class="form-control" id="c_diff_address2"
                      placeholder="Apartment, suite, unit etc. (optional)">
                  </div>
                  <div class="row g-3 mt-1">
                    <div class="col-md-6">
                      <label for="c_diff_state_country" class="form-label text-black">City / State <span
                          class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="c_diff_state_country" name="c_diff_state_country">
                    </div>
                    <div class="col-md-6">
                      <label for="c_diff_postal_zip" class="form-label text-black">Postal / Zip <span
                          class="text-danger">*</span></label>
                      <input type="text" class="form-control" id="c_diff_postal_zip" name="c_diff_postal_zip">
                    </div>
                  </div>
                  <div class="row g-3 mt-1 mb-3">
                    <div class="col-md-6">
                      <label for="c_diff_email_address" class="form-label text-black">Email Address <span
                          class="text-danger">*</span></label>
                      <input type="email" class="form-control" id="c_diff_email_address" name="c_diff_email_address">
                    </div>
                    <div class="col-md-6">
                      <label for="c_diff_phone" class="form-label text-black">Phone <span
                          class="text-danger">*</span></label>
                      <input type="tel" class="form-control" id="c_diff_phone" name="c_diff_phone"
                        placeholder="Phone Number">
                    </div>
                  </div>
                </div>
              </div>
            </div> 

            <div class="mb-0">
              <label for="c_order_notes" class="form-label text-black">Order Notes</label>
              <textarea name="c_order_notes" id="c_order_notes" rows="4" class="form-control"
                placeholder="Write your notes here..."></textarea>
            </div>
          </div>
        </div>

        <!-- Order + Payment -->
        <div class="col-md-6">
          <!-- Coupon (optional) -->
          <div class="row mb-4">
            <div class="col-md-12">
              <h2 class="h3 mb-3 text-black">Coupon Code</h2>
              <div class="p-3 p-lg-4 border bg-white">
                <label for="c_code" class="text-black mb-2">Enter your coupon code if you have one</label>
                <div class="input-group w-100 couponcode-wrap">
                  <input type="text" class="form-control" id="c_code" placeholder="Coupon Code"
                    aria-label="Coupon Code">
                  <button class="btn btn-black" type="button" id="couponApplyBtn">Apply</button>
                </div>
                <div id="couponMsg" class="small mt-2"></div>
              </div>
            </div>
          </div>

          <!-- Order Summary -->
          <div class="row mb-4">
            <div class="col-md-12">
              <h2 class="h3 mb-3 text-black">Your Order</h2>
              <div class="p-3 p-lg-4 border bg-white">
                <table class="table site-block-order-table mb-4" id="orderTable">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th class="text-end">Total</th>
                    </tr>
                  </thead>
                  <tbody id="orderLines"><!-- JS injects rows here --></tbody>
                  <tfoot>
                    <tr>
                      <td class="text-black fw-semibold">Cart Subtotal</td>
                      <td class="text-black text-end" id="cartSubtotal">$0.00</td>
                    </tr>
                    <tr id="rowDiscount" class="d-none">
                      <td class="text-success">Discount</td>
                      <td class="text-success text-end" id="cartDiscount">-$0.00</td>
                    </tr>
                    <tr>
                      <td class="text-black fw-semibold">Order Total</td>
                      <td class="text-black fw-semibold text-end" id="orderTotal">$0.00</td>
                    </tr>
                  </tfoot>
                </table>

                <!-- Payment Methods -->
                <h2 class="h6 mb-3">Payment</h2>
                <div class="border rounded p-3 mb-3">
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="payment_method" id="pm_cod" value="COD" checked>
                    <label class="form-check-label" for="pm_cod"><strong>Cash on Delivery (COD)</strong></label>
                    <div class="small text-muted mt-1">Pay in cash when the order is delivered. Please keep the exact
                      amount ready.</div>
                  </div>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="payment_method" id="pm_bank"
                      value="BankTransfer">
                    <label class="form-check-label" for="pm_bank"><strong>Bank Transfer</strong></label>
                    <div class="small text-muted mt-1">
                      Transfer your amount to this account number: <strong id="bankAcct">00447459338023</strong>.<br>
                      After payment your order will be confirmed!
                    </div>
                  </div>
                </div>

                <button id="placeOrderBtn" class="btn btn-black btn-lg w-100">Place Order</button>
                <div id="checkoutMsg" class="small mt-2"></div>

              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (optional for collapse/toggles) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /********************** CONFIG **********************/
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwqPVDv0hPrLII9XQ0AC5LK7Lbs5RhVeAi9xZeooMuIt89y0V4PnBVsZ0ejGERtN5A0/exec';
    const CURRENCY = 'USD'; // change to 'PKR' if needed

    /********************** CART HELPERS **********************/
    function readCart() {
      try {
        const raw = localStorage.getItem('cart');
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        return [];
      }
    }

    function normalizeCart(items) {
      return (items || []).map(it => ({
        id: it.id || it.sku || '',
        name: it.name || it.title || 'Item',
        price: Number(it.price) || 0,
        qty: Number(it.qty || it.quantity || 1),
        image: it.image || ''
      }));
    }

    function calcTotals(items) {
      const subtotal = items.reduce((sum, it) => sum + (it.price * it.qty), 0);
      const discount = window.__couponDiscount || 0; // set by coupon logic
      const total = Math.max(0, subtotal - discount);
      return { subtotal, discount, total };
    }

    function fmtMoney(n) {
      return new Intl.NumberFormat(undefined, { style: 'currency', currency: CURRENCY }).format(Number(n) || 0);
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[c]));
    }

    /********************** RENDER ORDER **********************/
    function renderOrder(items) {
      const tbody = document.getElementById('orderLines');
      const elSub = document.getElementById('cartSubtotal');
      const elTotal = document.getElementById('orderTotal');
      const rowDiscount = document.getElementById('rowDiscount');
      const elDiscount = document.getElementById('cartDiscount');

      tbody.innerHTML = '';
      items.forEach(it => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
      <td>${escapeHtml(it.name)} <strong class="mx-2">x</strong> ${it.qty}</td>
      <td class="text-end">${fmtMoney(it.price * it.qty)}</td>`;
        tbody.appendChild(tr);
      });

      const { subtotal, discount, total } = calcTotals(items);
      elSub.textContent = fmtMoney(subtotal);
      elTotal.textContent = fmtMoney(total);

      if (discount > 0) {
        rowDiscount.classList.remove('d-none');
        elDiscount.textContent = '-' + fmtMoney(discount);
      } else {
        rowDiscount.classList.add('d-none');
      }
    }

    /********************** FORM DATA **********************/
    function getCustomerData() {
      const countrySel = document.getElementById('c_country');
      const fullName = `${(document.getElementById('c_fname').value || '').trim()} ${(document.getElementById('c_lname').value || '').trim()}`.trim();

      return {
        fullName,
        email: (document.getElementById('c_email_address').value || '').trim(),
        phone: (document.getElementById('c_phone').value || '').trim(),
        address1: (document.getElementById('c_address').value || '').trim(),
        address2: (document.getElementById('c_address2').value || '').trim(),
        city: (document.getElementById('c_state_country').value || '').trim(),
        state: (document.getElementById('c_state_country').value || '').trim(),
        zip: (document.getElementById('c_postal_zip').value || '').trim(),
        country: countrySel?.options[countrySel.selectedIndex]?.text || '',
        notes: (document.getElementById('c_order_notes').value || '').trim()
      };
    }

    function getPaymentMethod() {
      const el = document.querySelector('input[name="payment_method"]:checked');
      return el ? el.value : 'COD';
    }

    /********************** VALIDATION **********************/
    function validate(customer, items) {
      const errors = [];
      if (!items.length) errors.push('Your cart is empty.');
      if (!customer.fullName) errors.push('First and last name are required.');
      if (!customer.email || !/^\S+@\S+\.\S+$/.test(customer.email)) errors.push('Valid email is required.');
      if (!customer.phone) errors.push('Phone is required.');
      if (!customer.address1) errors.push('Address is required.');
      if (!customer.zip) errors.push('Postal/ZIP is required.');
      if (!customer.country || customer.country.toLowerCase().includes('select')) errors.push('Please select a country.');
      return errors;
    }

    /********************** ORDER SUBMIT **********************/
    function generateOrderId() {
      const d = new Date();
      const ymd = d.toISOString().slice(0, 10).replaceAll('-', '');
      const rand = Math.random().toString(36).slice(2, 8).toUpperCase();
      return `ORD-${ymd}-${rand}`;
    }

    async function submitOrder() {
      const btn = document.getElementById('placeOrderBtn');
      const msg = document.getElementById('checkoutMsg');
      msg.textContent = '';
      msg.className = 'small mt-2'; // reset

      const cart = normalizeCart(readCart());
      const { subtotal, total } = calcTotals(cart);
      const customer = getCustomerData();
      const paymentMethod = getPaymentMethod();

      const errs = validate(customer, cart);
      if (errs.length) {
        msg.textContent = errs.join(' ');
        msg.className = 'small mt-2 text-danger';
        return;
      }

      const orderId = generateOrderId();
      const payload = {
        orderId,
        paymentMethod,
        customer,
        items: cart,
        subtotal,
        total,
        notes: customer.notes || ''
      };

      try {
        btn.disabled = true;
        btn.textContent = 'Placing Order...';

        // IMPORTANT: text/plain to avoid preflight (Apps Script doesn't handle OPTIONS)
        const res = await fetch("https://script.google.com/macros/s/AKfycbyst4ZCZIYFdGOsvBORifGSjwpHOX3_uS0LLm18lJoRE9s31hLZQ-W9cMKEZYL7yd3z/exec", {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" }, // text/plain avoids CORS issues
          body: JSON.stringify(payload)
        });


        const raw = await res.text();
        console.log('Apps Script response:', raw);

        if (!res.ok) {
          throw new Error(`HTTP ${res.status} ${res.statusText}`);
        }

        let data;
        try {
          data = JSON.parse(raw);
        } catch (e) {
          throw new Error('Bad JSON from Apps Script: ' + raw.slice(0, 200));
        }

        if (data.ok) {
          localStorage.removeItem('cart');
          window.location.href = `thankyou.html?order=${encodeURIComponent(orderId)}`;
        } else {
          throw new Error(data.error || 'Unknown error from Apps Script');
        }
      } catch (e) {
        console.error(e);
        msg.textContent = 'Could not place order. Please try again or contact support.';
        msg.className = 'small mt-2 text-danger';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Place Order';
      }
    }

    /********************** COUPON (optional demo) **********************/
    function applyCoupon() {
      const code = (document.getElementById('c_code').value || '').trim().toUpperCase();
      const msg = document.getElementById('couponMsg');

      if (code === 'SAVE10') {
        const cart = normalizeCart(readCart());
        const subtotal = cart.reduce((s, it) => s + it.price * it.qty, 0);
        window.__couponDiscount = +(subtotal * 0.10).toFixed(2);
        msg.textContent = 'Coupon applied: 10% off';
        msg.className = 'small mt-2 text-success';
        renderOrder(cart);
      } else if (code) {
        msg.textContent = 'Invalid coupon code';
        msg.className = 'small mt-2 text-danger';
      } else {
        msg.textContent = '';
      }
    }

    /********************** INIT **********************/
    document.addEventListener('DOMContentLoaded', () => {
      // Bootstrap collapses from checkboxes
      const createAcc = document.getElementById('c_create_account');
      const shipDiff = document.getElementById('c_ship_different_address');
      const accCollapse = new bootstrap.Collapse('#create_an_account', { toggle: false });
      const shipCollapse = new bootstrap.Collapse('#ship_different_address', { toggle: false });

      createAcc.addEventListener('change', () => createAcc.checked ? accCollapse.show() : accCollapse.hide());
      shipDiff.addEventListener('change', () => shipDiff.checked ? shipCollapse.show() : shipCollapse.hide());

      // Render items from localStorage
      const cart = normalizeCart(readCart());
      renderOrder(cart);

      // Actions
      document.getElementById('placeOrderBtn').addEventListener('click', e => { e.preventDefault(); submitOrder(); });
      document.getElementById('couponApplyBtn').addEventListener('click', e => { e.preventDefault(); applyCoupon(); });
    });
  </script>

</body>


</html>

